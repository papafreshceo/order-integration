<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>구매관리</title>
    <style>
        .purchase-container {
            padding: 20px;
            background: #fafafa;
            min-height: 100vh;
        }

        .header-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 500;
            color: #212529;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #2563eb;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #ffffff;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .table-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: calc(100vh - 250px);
        }

        .purchase-table {
            width: 100%;
            border-collapse: collapse;
        }

        .purchase-table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        .purchase-table th {
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }

        .purchase-table td {
            padding: 4px;
            border: 1px solid #e9ecef;
            position: relative;
        }

        .purchase-table tbody tr:hover {
            background: #f8f9fa;
        }

        .cell-input {
            width: 100%;
            border: none;
            padding: 6px 8px;
            font-size: 13px;
            font-weight: 300;
            background: transparent;
            outline: none;
            text-align: center;
        }

        .cell-input:focus {
            background: #ffffff;
            box-shadow: inset 0 0 0 2px #2563eb;
            border-radius: 4px;
        }

        .cell-input.number {
            text-align: right;
        }

        .cell-input[readonly] {
            background: #f8f9fa;
            cursor: not-allowed;
            color: #6c757d;
        }

        .new-row-btn {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 1px dashed #dee2e6;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .new-row-btn:hover {
            background: #e7f3ff;
            border-color: #2563eb;
            color: #2563eb;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 10000;
        }

        .toast.show {
            display: block;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="purchase-container">
        <div class="header-section">
            <h1 class="header-title">구매관리</h1>
            <div class="header-actions">
                <button class="btn-secondary" onclick="PurchaseManager.refreshData()">새로고침</button>
                <button class="btn-primary" onclick="PurchaseManager.saveData()">저장</button>
            </div>
        </div>

        <div class="table-section">
            <div class="table-wrapper">
                <table class="purchase-table" id="purchaseTable">
                    <thead>
                        <tr>
                            <th style="width: 100px;">날짜</th>
                            <th style="width: 100px;">중매인</th>
                            <th style="width: 100px;">출하자</th>
                            <th style="width: 100px;">품종</th>
                            <th style="width: 100px;">규격</th>
                            <th style="width: 80px;">수량</th>
                            <th style="width: 100px;">단가</th>
                            <th style="width: 120px;">금액</th>
                            <th style="width: 100px;">수수료</th>
                            <th style="width: 120px;">합계</th>
                            <th style="width: 100px;">작업</th>
                            <th style="width: 100px;">맛</th>
                            <th style="width: 200px;">비고</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseTableBody">
                        <tr>
                            <td colspan="13">
                                <div class="empty-state">
                                    <h3>데이터 로딩 중...</h3>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const PurchaseManager = {
            data: [],
            hasChanges: false,

            async init() {
                console.log('구매관리 초기화 시작');
                await this.loadData();
                this.setupAutoSave();
            },

            async loadData() {
                this.showLoading();
                try {
                    const response = await fetch('/api/purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getPurchaseData',
                            range: '구매관리!A:M'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('API 응답:', result);
                    
                    if (result.success && result.data) {
                        this.data = result.data.slice(1) || []; // 헤더 제외
                        this.renderTable();
                        this.showToast('데이터 로드 완료');
                    } else {
                        // 데이터가 없으면 빈 테이블 표시
                        this.data = [];
                        this.renderTable();
                    }
                } catch (error) {
                    console.error('데이터 로드 실패:', error);
                    this.showToast('데이터 로드 실패', 'error');
                    // 에러 시 빈 테이블 표시
                    this.data = [];
                    this.renderTable();
                } finally {
                    this.hideLoading();
                }
            },

            renderTable() {
                const tbody = document.getElementById('purchaseTableBody');
                tbody.innerHTML = '';

                // 데이터가 있으면 렌더링
                if (this.data && this.data.length > 0) {
                    this.data.forEach((row, index) => {
                        this.addRow(row, index);
                    });
                }

                // 새 행 추가 버튼
                const newRowTr = document.createElement('tr');
                newRowTr.innerHTML = `
                    <td colspan="13">
                        <button class="new-row-btn" onclick="PurchaseManager.addNewRow()">+ 새 행 추가</button>
                    </td>
                `;
                tbody.appendChild(newRowTr);
            },

            addRow(rowData = [], rowIndex) {
                const tbody = document.getElementById('purchaseTableBody');
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = rowIndex;

                const columns = [
                    { index: 0, type: 'date', name: '날짜' },
                    { index: 1, type: 'text', name: '중매인' },
                    { index: 2, type: 'text', name: '출하자' },
                    { index: 3, type: 'text', name: '품종' },
                    { index: 4, type: 'text', name: '규격' },
                    { index: 5, type: 'number', name: '수량' },
                    { index: 6, type: 'number', name: '단가' },
                    { index: 7, type: 'number', name: '금액', readonly: true },
                    { index: 8, type: 'number', name: '수수료' },
                    { index: 9, type: 'number', name: '합계', readonly: true },
                    { index: 10, type: 'text', name: '작업' },
                    { index: 11, type: 'text', name: '맛' },
                    { index: 12, type: 'text', name: '비고' }
                ];

                columns.forEach(col => {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    
                    input.className = 'cell-input';
                    
                    if (col.type === 'date') {
                        input.type = 'date';
                    } else if (col.type === 'number') {
                        input.type = 'text';
                        input.className += ' number';
                    } else {
                        input.type = 'text';
                    }

                    if (col.readonly) {
                        input.readOnly = true;
                    }

                    input.value = rowData[col.index] || '';
                    input.dataset.column = col.index;
                    input.dataset.row = rowIndex;

                    // 이벤트 리스너
                    if (col.name === '수량' || col.name === '단가' || col.name === '수수료') {
                        input.addEventListener('input', () => this.calculateRow(rowIndex));
                    }

                    input.addEventListener('change', () => {
                        this.updateCell(rowIndex, col.index, input.value);
                    });

                    td.appendChild(input);
                    tr.appendChild(td);
                });

                // 마지막 행 앞에 삽입
                const lastRow = tbody.lastElementChild;
                if (lastRow && lastRow.querySelector('.new-row-btn')) {
                    tbody.insertBefore(tr, lastRow);
                } else {
                    tbody.appendChild(tr);
                }

                // 자동 계산
                this.calculateRow(rowIndex);
            },

            addNewRow() {
                const newIndex = this.data.length;
                const today = new Date().toISOString().split('T')[0];
                const newRow = Array(13).fill('');
                newRow[0] = today;
                
                this.data.push(newRow);
                this.addRow(newRow, newIndex);
                this.hasChanges = true;
            },

            calculateRow(rowIndex) {
                const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                if (!row) return;

                const quantity = parseFloat(row.querySelector('input[data-column="5"]').value) || 0;
                const unitPrice = parseFloat(row.querySelector('input[data-column="6"]').value) || 0;
                const commission = parseFloat(row.querySelector('input[data-column="8"]').value) || 0;

                const amount = quantity * unitPrice;
                const total = amount + commission;

                row.querySelector('input[data-column="7"]').value = amount ? amount.toLocaleString() : '';
                row.querySelector('input[data-column="9"]').value = total ? total.toLocaleString() : '';

                // 데이터 업데이트
                if (!this.data[rowIndex]) {
                    this.data[rowIndex] = Array(13).fill('');
                }
                this.data[rowIndex][7] = amount.toString();
                this.data[rowIndex][9] = total.toString();
                this.hasChanges = true;
            },

            updateCell(rowIndex, columnIndex, value) {
                if (!this.data[rowIndex]) {
                    this.data[rowIndex] = Array(13).fill('');
                }
                this.data[rowIndex][columnIndex] = value;
                this.hasChanges = true;
            },

            async saveData() {
                if (!this.hasChanges) {
                    this.showToast('변경사항이 없습니다');
                    return;
                }

                this.showLoading();
                try {
                    const response = await fetch('/api/purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updatePurchaseData',
                            range: '구매관리!A2:M',
                            data: this.data
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showToast('저장 완료');
                        this.hasChanges = false;
                    } else {
                        throw new Error('저장 실패');
                    }
                } catch (error) {
                    console.error('저장 오류:', error);
                    this.showToast('저장 실패', 'error');
                } finally {
                    this.hideLoading();
                }
            },

            async refreshData() {
                if (this.hasChanges) {
                    if (!confirm('저장하지 않은 변경사항이 있습니다. 새로고침하시겠습니까?')) {
                        return;
                    }
                }
                await this.loadData();
            },

            setupAutoSave() {
                // 5분마다 자동 저장
                setInterval(() => {
                    if (this.hasChanges) {
                        this.saveData();
                    }
                }, 300000);

                // 페이지 떠나기 전 확인
                window.addEventListener('beforeunload', (e) => {
                    if (this.hasChanges) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            },

            showLoading() {
                document.getElementById('loadingOverlay').classList.add('show');
            },

            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('show');
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast show ${type === 'error' ? 'error' : ''}`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            PurchaseManager.init();
        });
    </script>
</body>
</html>